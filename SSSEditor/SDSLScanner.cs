using BrawlManagerLib;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;

namespace SSSEditor {
	public static class SDSLScanner {
		#region Song IDs and filenames
		private static Dictionary<ushort, string> songs = new Dictionary<ushort, string>();

		public static string SongFilenameFromID(ushort id) {
			return songs[id];
		}

		private static void songadd(string name, string filename, int id, bool unsure) {
			ushort nid = (ushort)id;
			songs.Add(nid, filename);
		}

		static SDSLScanner() {
			songs.Add(0x26f9, "X01");
			songs.Add(0x26fa, "X02");
			songs.Add(0x26fb, "X03");
			songs.Add(0x26fc, "X04");
			songs.Add(0x26fd, "X05");
			songs.Add(0x26fe, "X06");
			songs.Add(0x26ff, "X07");
			songs.Add(0x2700, "X08");
			songs.Add(0x2701, "X09");
			songs.Add(0x2702, "X10");
			songs.Add(0x2703, "X11");
			songs.Add(0x2705, "X13");
			songs.Add(0x2707, "X15");
			songs.Add(0x2708, "X16");
			songs.Add(0x2709, "X17");
			songs.Add(0x270a, "X18");
			songs.Add(0x270b, "X19");
			songs.Add(0x270c, "X20");
			songs.Add(0x270d, "X21");
			songs.Add(0x270e, "X22");
			songs.Add(0x270f, "X23");
			songs.Add(0x2711, "X25");
			songs.Add(0x2712, "X26");
			songs.Add(0x2713, "X27");
			songs.Add(0x2714, "A01");
			songs.Add(0x2715, "A02");
			songs.Add(0x2716, "A03");
			songs.Add(0x2717, "A04");
			songs.Add(0x2718, "A05");
			songs.Add(0x2719, "A06");
			songs.Add(0x271a, "A07");
			songs.Add(0x271b, "A08");
			songs.Add(0x271c, "A09");
			songs.Add(0x271d, "A10");
			songs.Add(0x2720, "A13");
			songs.Add(0x2721, "A14");
			songs.Add(0x2722, "A15");
			songs.Add(0x2723, "A16");
			songs.Add(0x2724, "A17");
			songs.Add(0x2725, "A20");
			songs.Add(0x2726, "A21");
			songs.Add(0x2727, "A22");
			songs.Add(0x2728, "A23");
			songs.Add(0x2729, "B01");
			songs.Add(0x272a, "B02");
			songs.Add(0x272b, "B03");
			songs.Add(0x272c, "B04");
			songs.Add(0x272d, "B05");
			songs.Add(0x272e, "B06");
			songs.Add(0x272f, "B07");
			songs.Add(0x2730, "B08");
			songs.Add(0x2731, "B09");
			songs.Add(0x2732, "B10");
			songs.Add(0x2733, "C01");
			songs.Add(0x2734, "C02");
			songs.Add(0x2735, "C03");
			songs.Add(0x2736, "C04");
			songs.Add(0x2737, "C05");
			songs.Add(0x2739, "C07");
			songs.Add(0x273a, "C08");
			songs.Add(0x273b, "C09");
			songs.Add(0x273c, "C10");
			songs.Add(0x273d, "C11");
			songs.Add(0x273e, "C12");
			songs.Add(0x273f, "C13");
			songs.Add(0x2740, "C14");
			songs.Add(0x2741, "C15");
			songs.Add(0x2742, "C16");
			songs.Add(0x2743, "C17");
			songs.Add(0x2744, "C18");
			songs.Add(0x2745, "C19");
			songs.Add(0x2746, "D01");
			songs.Add(0x2747, "D02");
			songs.Add(0x2748, "D03");
			songs.Add(0x2749, "D04");
			songs.Add(0x274a, "D05");
			songs.Add(0x274b, "D06");
			songs.Add(0x274c, "D07");
			songs.Add(0x274d, "D08");
			songs.Add(0x274e, "D09");
			songs.Add(0x274f, "D10");
			songs.Add(0x2750, "E01");
			songs.Add(0x2751, "E02");
			songs.Add(0x2752, "E03");
			songs.Add(0x2754, "E05");
			songs.Add(0x2755, "E06");
			songs.Add(0x2757, "F01");
			songs.Add(0x2758, "F02");
			songs.Add(0x2759, "F03");
			songs.Add(0x275a, "F04");
			songs.Add(0x275b, "F05");
			songs.Add(0x275c, "F06");
			songs.Add(0x275d, "F07");
			songs.Add(0x275e, "F08");
			songs.Add(0x275f, "F09");
			songs.Add(0x2760, "F10");
			songs.Add(0x2761, "F11");
			songs.Add(0x2762, "F12");
			songs.Add(0x2763, "G01");
			songs.Add(0x2764, "G02");
			songs.Add(0x2765, "G03");
			songs.Add(0x2766, "G04");
			songs.Add(0x2767, "G05");
			songs.Add(0x2769, "G07");
			songs.Add(0x276a, "G08");
			songs.Add(0x276b, "G09");
			songs.Add(0x276c, "G10");
			songs.Add(0x276d, "G11");
			songs.Add(0x276e, "H01");
			songs.Add(0x276f, "H02");
			songs.Add(0x2770, "H03");
			songs.Add(0x2771, "H04");
			songs.Add(0x2772, "H05");
			songs.Add(0x2773, "H06");
			songs.Add(0x2774, "H07");
			songs.Add(0x2775, "H08");
			songs.Add(0x2776, "H09");
			songs.Add(0x2777, "H10");
			songs.Add(0x2778, "I01");
			songs.Add(0x2779, "I02");
			songs.Add(0x277a, "I03");
			songs.Add(0x277b, "I04");
			songs.Add(0x277c, "I05");
			songs.Add(0x277d, "I06");
			songs.Add(0x277e, "I07");
			songs.Add(0x277f, "I08");
			songs.Add(0x2780, "I09");
			songs.Add(0x2781, "I10");
			songs.Add(0x2783, "J02");
			songs.Add(0x2784, "J03");
			songs.Add(0x2785, "J04");
			songs.Add(0x2787, "J06");
			songs.Add(0x2788, "J07");
			songs.Add(0x2789, "J08");
			songs.Add(0x278a, "J09");
			songs.Add(0x278b, "J10");
			songs.Add(0x278c, "J11");
			songs.Add(0x278d, "J12");
			songs.Add(0x278e, "J13");
			songs.Add(0x278f, "K01");
			songs.Add(0x2793, "K05");
			songs.Add(0x2795, "K07");
			songs.Add(0x2796, "K08");
			songs.Add(0x2797, "K09");
			songs.Add(0x2798, "K10");
			songs.Add(0x2799, "L01");
			songs.Add(0x279a, "L02");
			songs.Add(0x279b, "L03");
			songs.Add(0x279c, "L04");
			songs.Add(0x279d, "L05");
			songs.Add(0x279e, "L06");
			songs.Add(0x279f, "L07");
			songs.Add(0x27a0, "L08");
			songs.Add(0x27a1, "M01");
			songs.Add(0x27a2, "M02");
			songs.Add(0x27a3, "M03");
			songs.Add(0x27a4, "M04");
			songs.Add(0x27a5, "M05");
			songs.Add(0x27a6, "M06");
			songs.Add(0x27a7, "M07");
			songs.Add(0x27a8, "M08");
			songs.Add(0x27b3, "N01");
			songs.Add(0x27b4, "N02");
			songs.Add(0x27b5, "N03");
			songs.Add(0x27b7, "N05");
			songs.Add(0x27b8, "N06");
			songs.Add(0x27b9, "N07");
			songs.Add(0x27ba, "N08");
			songs.Add(0x27bb, "N09");
			songs.Add(0x27bc, "N10");
			songs.Add(0x27bd, "N11");
			songs.Add(0x27be, "N12");
			songs.Add(0x27bf, "P01");
			songs.Add(0x27c0, "P02");
			songs.Add(0x27c1, "P03");
			songs.Add(0x27c2, "P04");
			songs.Add(0x27c3, "Q01");
			songs.Add(0x27c4, "Q02");
			songs.Add(0x27c6, "Q04");
			songs.Add(0x27c7, "Q05");
			songs.Add(0x27c8, "Q06");
			songs.Add(0x27c9, "Q07");
			songs.Add(0x27ca, "Q08");
			songs.Add(0x27cb, "Q09");
			songs.Add(0x27cc, "Q10");
			songs.Add(0x27cd, "Q11");
			songs.Add(0x27ce, "Q12");
			songs.Add(0x27cf, "Q13");
			songs.Add(0x27d0, "Q14");
			songs.Add(0x27d2, "R02");
			songs.Add(0x27d3, "R03");
			songs.Add(0x27d4, "R04");
			songs.Add(0x27d5, "R05");
			songs.Add(0x27d6, "R06");
			songs.Add(0x27d7, "R07");
			songs.Add(0x27d8, "R08");
			songs.Add(0x27d9, "R09");
			songs.Add(0x27da, "R10");
			songs.Add(0x27db, "R11");
			songs.Add(0x27dc, "R12");
			songs.Add(0x27dd, "R13");
			songs.Add(0x27de, "R14");
			songs.Add(0x27df, "R15");
			songs.Add(0x27e0, "R16");
			songs.Add(0x27e1, "R17");
			songs.Add(0x27e3, "S02");
			songs.Add(0x27e4, "S03");
			songs.Add(0x27e5, "S04");
			songs.Add(0x27e6, "S05");
			songs.Add(0x27e7, "S06");
			songs.Add(0x27e8, "S07");
			songs.Add(0x27e9, "S08");
			songs.Add(0x27eb, "S10");
			songs.Add(0x27ec, "S11");
			songs.Add(0x27ed, "T01");
			songs.Add(0x27ee, "T02");
			songs.Add(0x27ef, "T03");
			songs.Add(0x27f1, "T05");
			songs.Add(0x27f2, "U01");
			songs.Add(0x27f3, "U02");
			songs.Add(0x27f4, "U03");
			songs.Add(0x27f5, "U04");
			songs.Add(0x27f7, "U06");
			songs.Add(0x27f8, "U07");
			songs.Add(0x27f9, "U08");
			songs.Add(0x27fa, "U09");
			songs.Add(0x27fb, "U10");
			songs.Add(0x27fc, "U11");
			songs.Add(0x27fd, "U12");
			songs.Add(0x27fe, "U13");
			songs.Add(0x27ff, "W01");
			songs.Add(0x2800, "W02");
			songs.Add(0x2801, "W03");
			songs.Add(0x2802, "W04");
			songs.Add(0x2803, "W05");
			songs.Add(0x2804, "W06");
			songs.Add(0x2805, "W07");
			songs.Add(0x2806, "W08");
			songs.Add(0x2807, "W09");
			songs.Add(0x2808, "W10");
			songs.Add(0x2809, "W11");
			songs.Add(0x280a, "W12");
			songs.Add(0x280b, "W13");
			songs.Add(0x280c, "W14");
			songs.Add(0x280d, "W15");
			songs.Add(0x280e, "W16");
			songs.Add(0x280f, "W17");
			songs.Add(0x2810, "W18");
			songs.Add(0x2811, "W19");
			songs.Add(0x2812, "W20");
			songs.Add(0x2813, "W21");
			songs.Add(0x2815, "W23");
			songs.Add(0x2816, "W24");
			songs.Add(0x2817, "W25");
			songs.Add(0x2818, "W26");
			songs.Add(0x2819, "W27");
			songs.Add(0x281a, "W28");
			songs.Add(0x281b, "W29");
			songs.Add(0x281c, "W30");
			songs.Add(0x281d, "W31");
			songs.Add(0x281f, "Y01");
			songs.Add(0x2820, "Y02");
			songs.Add(0x2821, "Y03");
			songs.Add(0x2822, "Y04");
			songs.Add(0x2823, "Y05");
			songs.Add(0x2824, "???");
			songs.Add(0x2825, "Y07");
			songs.Add(0x2826, "Y08");
			songs.Add(0x2827, "Y09");
			songs.Add(0x2828, "Y10");
			songs.Add(0x2829, "Y11");
			songs.Add(0x282a, "Y12");
			songs.Add(0x282b, "Y13");
			songs.Add(0x282c, "Y14");
			songs.Add(0x282d, "Y15");
			songs.Add(0x282e, "Y16");
			songs.Add(0x282f, "Y17");
			songs.Add(0x2863, "Z50");
			songs.Add(0x2864, "Z51");
			songs.Add(0x2867, "Z54");
			songs.Add(0x2868, "Z55");
			songs.Add(0x2869, "Z56");
			songs.Add(0x286a, "Z57");
			songs.Add(0x286b, "Z58");
		}
		#endregion

		private static byte[] SDSL_HEADER = { 0x28, 0x70, 0x8c, 0xeb, 0x00, 0x00, 0x00 };
		public static Dictionary<byte, Tuple<string, ushort>> SongsByStage(CustomSSS sss) {
			return SongsByStage(sss.DataBefore.Concat(sss.DataAfter).ToArray());
		}
		public static Dictionary<byte, Tuple<string, ushort>> SongsByStage(byte[] data) {
			Dictionary<byte, Tuple<string, ushort>> dict = new Dictionary<byte, Tuple<string, ushort>>();
			for (int line = 0; line < data.Length; line += 8) {
				if (ByteUtilities.ByteArrayEquals(data, line, SDSL_HEADER, 0, SDSL_HEADER.Length)) {
					byte stageID = data[line + 7];
					byte songID1 = data[line + 22];
					byte songID2 = data[line + 23];
					ushort songID = (ushort)(0x100 * songID1 + songID2);
					string n = SongFilenameFromID(songID);
					if (dict.ContainsKey(stageID)) {
						Console.WriteLine(String.Format("WARNING: code mapping stage {0} to song {1} will not " +
							"take effect, since a later code maps it to song {2}", stageID, dict[stageID], n));
						dict.Remove(stageID);
					}
					dict.Add(stageID, new Tuple<string, ushort>(n, songID));
					line += 24;
				}
			}
			return dict;
		}
	}
}
